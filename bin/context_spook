#!/usr/bin/env ruby

require 'context_spook'
require 'tins/go'
include Tins::GO
require 'json'
require 'pathname'

# The usage method displays the command-line interface help text and example
# usage patterns for the ContextSpook tool.
#
# This method outputs a formatted help message that includes the tool's usage
# syntax, available options, and practical examples.
#
# @see ContextSpook::generate_context
# @see ContextSpook::Generator
# @see ContextSpook::Generator::Context
def usage
  puts <<~EOT

  Usage: #{File.basename($0)} [options] <context_definition_file>

  Options:
    -o FILE      Write output to FILE instead of stdout
    ~v           Disable verbose output, enabled by default
    -h           Show this help message
    -i PATTERN   Include files matching PATTERN (can be used multiple times)
                 Supports glob patterns like **, *, ?, [abc], {a,b,c}

  Examples:
    # Generate context and output to stdout
    #{File.basename($0)} .contexts/project.rb

    # Generate context with include patterns
    #{File.basename($0)} -i 'lib/**/*.rb'
    #{File.basename($0)} -i 'lib/**/*.rb' -i 'spec/**/*.rb'
    #{File.basename($0)} -i 'lib/**/*.rb' -i 'lib/**/*.js'

    # Complex glob patterns
    #{File.basename($0)} -i 'lib/**/{*.rb,*.rake}'     # Brace expansion
    #{File.basename($0)} -i 'lib/**/*_spec.rb'         # Pattern matching
    #{File.basename($0)} -i 'lib/**/*.rb' -i 'spec/**/*_spec.rb'  # Mixed patterns

    # Generate context without verbose output
    #{File.basename($0)} .contexts/project.rb ~v

    # Generate context and save to file
    #{File.basename($0)} .contexts/project.rb -o context.json
  EOT
  exit 0
end

opts    = go 'o:i:pvh', defaults: { ?v => true }
opts[?h] and usage
context = nil
output  = nil

if opts[?i]
  context = ContextSpook.generate_context(verbose: opts[?v]) do
    context do
      opts[?i].to_a.each do |glob|
        Dir.glob(glob).each do |filename|
          Pathname.new(filename).file? or next
          file filename
        end
      end
    end
  end
else
  filename = ARGV.shift or fail 'require context definition file as an argument'
  context = ContextSpook.generate_context(filename, verbose: opts[?v])
end

if output_filename = opts[?o]
  if File.exist?(output_filename)
    fail "Filename #{output_filename.inspect} already exists!"
  end
  output = File.new output_filename, ?w
else
  output = STDOUT
end
JSON.dump(context.as_json, output)
